<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Le√ßon 2 ‚Äî CRUD Firestore (Multi-fichiers, SANS service/model/contr√¥leurs)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme:{ extend:{ colors:{
      soft:{50:'#fefefe',100:'#f8f9fa',200:'#f1f3f4',300:'#e8eaed',400:'#dadce0',500:'#c4c7c5',600:'#9aa0a6',700:'#5f6368'},
      lavender:{50:'#faf9ff',100:'#f5f3ff',200:'#ede9fe',300:'#ddd6fe',400:'#c4b5fd',500:'#a78bfa',600:'#8b5cf6'},
      sage:{50:'#f7f9f7',100:'#f0f4f0',200:'#dde8dd',300:'#c5d6c5',400:'#a8c2a8',500:'#8fad8f',600:'#759975'},
      peach:{50:'#fff9f7',100:'#fef2ee',200:'#fce4d6',300:'#f9d0b7',400:'#f5b895',500:'#f0a070',600:'#ea8a47'}
    }}}}
  </script>
  <style>
    html{scroll-behavior:smooth}
    body{background:linear-gradient(135deg,#faf9ff 0%,#f8f9fa 50%,#f7f9f7 100%)}
    .wrap{max-width:1000px;margin:auto;padding:24px}
    .card{background:linear-gradient(135deg,rgba(255,255,255,.95),rgba(250,249,255,.9));
          border:1px solid #ede9fe;border-radius:14px;padding:18px;margin:16px 0}
    h1,h2,h3{color:#374151}
    pre{background:linear-gradient(135deg,#f5f3ff,#f0f4f0);
        border:1px solid #e9d5ff;border-radius:12px;padding:14px;overflow:auto}
    code{font-family:ui-monospace,Menlo,Consolas,monospace}
    .btn{display:inline-block;background:linear-gradient(135deg,#a78bfa,#8b5cf6);color:#fff;border-radius:12px;padding:10px 14px;text-decoration:none}
    .badge{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;border-radius:9999px;background:#ea8a47;color:#fff;font-weight:700;margin-right:8px}
    .tip{border-left:4px solid #8b5cf6;background:#faf9ff;border-radius:8px;padding:10px;margin-top:8px}
    .warn{color:#b45309}
    .kbd{border:1px solid #e5e7eb;border-bottom-width:2px;border-radius:6px;padding:0 6px;background:#fff}
    .hl{background:#fff7ed;border:1px dashed #fdba74;border-radius:.5rem;padding:.5rem}
    .tick::before{content:"‚úî ";color:#16a34a}
  </style>
</head>
<body>
<div class="wrap">

  <header class="card" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
    <h1>Le√ßon 2 ‚Äî CRUD Firestore (multi-fichiers, <em>sans service / mod√®le / contr√¥leurs</em>)</h1>
    <nav class="hidden sm:flex gap-2">
      <a class="btn" href="#plan">Plan</a>
      <a class="btn" href="#fichiers">Fichiers</a>
      <a class="btn" href="#liste">Liste</a>
      <a class="btn" href="#form">Formulaire</a>
      <a class="btn" href="#main">main.dart</a>
    </nav>
  </header>

  <section class="card">
    <p class="text-soft">
      Objectif : r√©aliser un CRUD <strong>Membres</strong> en plusieurs fichiers, mais <u>sans</u> service ni mod√®le, et <u>sans TextEditingController</u>.
      Les pages parlent directement √† <span class="chip">Cloud Firestore</span> avec des <span class="hl">Map&lt;String,dynamic&gt;</span> et des
      <code>TextFormField(initialValue: ..., onChanged: ...)</code>.
    </p>
    <div class="tip">
      <p><strong>R√®gles Firestore ‚Äî MODE TEST UNIQUEMENT</strong> :</p>
<pre><code>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true; // ‚ö†Ô∏è Test seulement
    }
  }
}</code></pre>
    </div>
  </section>

  <!-- Plan -->
  <section id="plan" class="card">
    <h2>üìç Plan</h2>
    <ol>
      <li><span class="badge">0</span>Pr√©parer (packages + config)</li>
      <li><span class="badge">1</span>Arborescence des fichiers</li>
      <li><span class="badge">R</span>Page Liste (Lire + Supprimer + Aller vers Form)</li>
      <li><span class="badge">C/U</span>Page Formulaire (Cr√©er + Mettre √† jour, <em>sans contr√¥leurs</em>)</li>
      <li><span class="badge">‚ñ∂</span>main.dart (initialiser Firebase)</li>
      <li><span class="badge">‚òÖ</span>D√©cryptage ligne par ligne + D√©pannage</li>
    </ol>
  </section>

  <!-- 0) Pr√©parer -->
  <section class="card">
    <h2><span class="badge">0</span>Pr√©parer</h2>
    <p class="tick">Dans <code>pubspec.yaml</code> :</p>
<pre><code>dependencies:
  flutter:
    sdk: flutter
  firebase_core: ^3.5.0
  cloud_firestore: ^5.4.4
</code></pre>
    <p class="tick">Ex√©cute <span class="kbd">flutter pub get</span>, puis <span class="kbd">flutterfire configure</span> (g√©n√®re <code>firebase_options.dart</code>).</p>
    <p class="warn">En prod : on passera √† des r√®gles s√©curis√©es + Auth.</p>
  </section>

  <!-- 1) Arborescence -->
  <section id="fichiers" class="card">
    <h2><span class="badge">1</span>Arborescence minimale</h2>
<pre><code>lib/
  pages/
    member_list_page.dart
    member_form_page.dart
  main.dart
  firebase_options.dart   // g√©n√©r√© par flutterfire configure
</code></pre>
    <p class="tip">Les pages font tout : affichage + appels Firestore directs.</p>
  </section>

  <!-- 2) Liste -->
  <section id="liste" class="card">
    <h2><span class="badge">R</span>Page Liste ‚Äî <code>lib/pages/member_list_page.dart</code></h2>
<pre><code>import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'member_form_page.dart';

class MemberListPage extends StatelessWidget {
  const MemberListPage({super.key});

  Future&lt;void&gt; _confirmDelete(BuildContext context, String id, String name) async {
    final ok = await showDialog&lt;bool&gt;(
      context: context,
      builder: (ctx) =&gt; AlertDialog(
        title: const Text('Supprimer'),
        content: Text('Supprimer $name ?'),
        actions: [
          TextButton(onPressed: () =&gt; Navigator.pop(ctx, false), child: const Text('Annuler')),
          FilledButton(onPressed: () =&gt; Navigator.pop(ctx, true), child: const Text('Supprimer')),
        ],
      ),
    );
    if (ok == true) {
      await FirebaseFirestore.instance.collection('membres').doc(id).delete();
      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Membre supprim√©')));
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    final col = FirebaseFirestore.instance.collection('membres');

    return Scaffold(
      appBar: AppBar(title: const Text('Membres')),
      body: StreamBuilder&lt;QuerySnapshot&gt;(
        stream: col.orderBy('createdAt', descending: true).snapshots(),
        builder: (context, snap) {
          if (snap.hasError) return const Center(child: Text('Erreur de chargement'));
          if (snap.connectionState == ConnectionState.waiting) {
            return const Center(child: CircularProgressIndicator());
          }

          final docs = snap.data?.docs ?? [];
          if (docs.isEmpty) return const Center(child: Text('Aucun membre pour le moment'));

          return ListView.separated(
            itemCount: docs.length,
            separatorBuilder: (_, __) =&gt; const Divider(height: 1),
            itemBuilder: (context, i) {
              final d = docs[i];
              final data = d.data() as Map&lt;String, dynamic&gt;? ?? {};
              final first = (data['firstName'] ?? '').toString();
              final last  = (data['lastName'] ?? '').toString();
              final age   = (data['age'] ?? '').toString();
              final role  = (data['role'] ?? 'membre').toString();
              final note  = (data['note'] ?? '').toString();

              return ListTile(
                leading: CircleAvatar(child: Text(first.isNotEmpty ? first[0].toUpperCase() : '?')),
                title: Text('$first $last'),
                subtitle: Text('√Çge: $age ‚Äî R√¥le: $role${note.isNotEmpty ? " ‚Äî $note" : ""}'),
                onTap: () {
                  Navigator.push(
                    context,
                    MaterialPageRoute(
                      builder: (_) =&gt; MemberFormPage(
                        docId: d.id,
                        existing: data, // Map simple
                      ),
                    ),
                  );
                },
                trailing: IconButton(
                  icon: const Icon(Icons.delete_outline),
                  tooltip: 'Supprimer',
                  onPressed: () =&gt; _confirmDelete(context, d.id, '$first $last'),
                ),
              );
            },
          );
        },
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: () {
          Navigator.push(
            context,
            MaterialPageRoute(builder: (_) =&gt; const MemberFormPage()),
          );
        },
        child: const Icon(Icons.add),
      ),
    );
  }
}
</code></pre>

    <h3>üß† D√©cryptage ‚Äî <code>StreamBuilder</code> (ligne par ligne)</h3>
    <div class="tip">
      <p><code>final col = FirebaseFirestore.instance.collection('membres');</code> ‚Äî on pointe vers la collection.</p>
      <p><code>col.orderBy('createdAt', descending: true).snapshots()</code> ‚Äî on √©coute en temps r√©el, du plus r√©cent au plus ancien.</p>
      <p><code>if (snap.connectionState == ConnectionState.waiting)</code> ‚Äî pendant qu‚Äôon attend, on affiche un loader.</p>
      <p><code>final docs = snap.data?.docs ?? [];</code> ‚Äî si pas de donn√©es, on √©vite l‚Äôerreur en renvoyant une liste vide.</p>
      <p><code>d.data() as Map&lt;String,dynamic&gt;? ?? {}</code> ‚Äî on r√©cup√®re chaque document sous forme de Map (ou <code>{}</code> si absent).</p>
      <p><code>onTap: Navigator.push(...MemberFormPage(...))</code> ‚Äî on ouvre le formulaire en mode √©dition en passant <code>docId</code> + la Map.</p>
      <p><code>_confirmDelete(...)</code> ‚Äî petite bo√Æte ‚Äúes-tu s√ªr ?‚Äù, puis <code>delete()</code> direct sur le doc.</p>
    </div>
  </section>

  <!-- 3) Formulaire (sans contr√¥leurs) -->
  <section id="form" class="card">
    <h2><span class="badge">C/U</span>Page Formulaire ‚Äî <code>lib/pages/member_form_page.dart</code></h2>
<pre><code>import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';

class MemberFormPage extends StatefulWidget {
  final String? docId;                     // null = cr√©ation, non-null = √©dition
  final Map&lt;String, dynamic&gt;? existing;    // valeurs initiales si √©dition
  const MemberFormPage({super.key, this.docId, this.existing});

  @override
  State&lt;MemberFormPage&gt; createState() =&gt; _MemberFormPageState();
}

class _MemberFormPageState extends State&lt;MemberFormPage&gt; {
  final _formKey = GlobalKey&lt;FormState&gt;();

  // ‚úÖ Sans contr√¥leurs : on garde des variables simples
  String firstName = '';
  String lastName  = '';
  String role      = 'membre';
  String note      = '';
  String ageText   = '';  // on garde le texte saisi pour pouvoir valider

  bool _saving = false;

  @override
  void initState() {
    super.initState();
    final e = widget.existing;
    if (e != null) {
      firstName = (e['firstName'] ?? '').toString();
      lastName  = (e['lastName'] ?? '').toString();
      role      = (e['role'] ?? 'membre').toString();
      note      = (e['note'] ?? '').toString();
      final a   = e['age'];
      ageText   = a == null ? '' : a.toString();
    }
  }

  Future&lt;void&gt; _save() async {
    if (!_formKey.currentState!.validate()) return;

    setState(() =&gt; _saving = true);
    final col = FirebaseFirestore.instance.collection('membres');
    try {
      final age = int.tryParse(ageText.trim()) ?? 0;

      if (widget.docId == null) {
        // CREATE
        await col.add({
          'firstName': firstName.trim(),
          'lastName' : lastName.trim(),
          'age'      : age,
          'role'     : role.trim().isEmpty ? 'membre' : role.trim(),
          'note'     : note.trim().isEmpty ? null : note.trim(),
          'createdAt': FieldValue.serverTimestamp(),
          'updatedAt': FieldValue.serverTimestamp(),
        });
        if (!mounted) return;
        ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Membre ajout√©')));
      } else {
        // UPDATE
        await col.doc(widget.docId!).update({
          'firstName': firstName.trim(),
          'lastName' : lastName.trim(),
          'age'      : age,
          'role'     : role.trim().isEmpty ? 'membre' : role.trim(),
          'note'     : note.trim().isEmpty ? null : note.trim(),
          'updatedAt': FieldValue.serverTimestamp(),
        });
        if (!mounted) return;
        ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Membre modifi√©')));
      }

      if (mounted) Navigator.pop(context);
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Erreur: $e')));
      }
    } finally {
      if (mounted) setState(() =&gt; _saving = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    final isEdit = widget.docId != null;
    return Scaffold(
      appBar: AppBar(title: Text(isEdit ? 'Modifier un membre' : 'Nouveau membre')),
      body: SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(16),
          child: AbsorbPointer(
            absorbing: _saving, // d√©sactive les champs pendant l'enregistrement
            child: Form(
              key: _formKey,
              child: ListView(
                children: [
                  Row(
                    children: [
                      Expanded(
                        child: TextFormField(
                          initialValue: firstName,
                          decoration: const InputDecoration(
                            labelText: 'Pr√©nom',
                            border: OutlineInputBorder(),
                          ),
                          validator: (v) =&gt; (v == null || v.trim().isEmpty) ? 'Pr√©nom requis' : null,
                          onChanged: (v) =&gt; setState(() =&gt; firstName = v),
                        ),
                      ),
                      const SizedBox(width: 8),
                      Expanded(
                        child: TextFormField(
                          initialValue: lastName,
                          decoration: const InputDecoration(
                            labelText: 'Nom',
                            border: OutlineInputBorder(),
                          ),
                          validator: (v) =&gt; (v == null || v.trim().isEmpty) ? 'Nom requis' : null,
                          onChanged: (v) =&gt; setState(() =&gt; lastName = v),
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 12),
                  Row(
                    children: [
                      Expanded(
                        child: TextFormField(
                          initialValue: ageText,
                          decoration: const InputDecoration(
                            labelText: '√Çge',
                            border: OutlineInputBorder(),
                          ),
                          keyboardType: TextInputType.number,
                          validator: (v) {
                            if (v == null || v.trim().isEmpty) return null; // vide accept√© = 0
                            final n = int.tryParse(v.trim());
                            if (n == null) return 'Entrez un nombre';
                            if (n &lt; 0) return '√Çge ‚â• 0';
                            return null;
                          },
                          onChanged: (v) =&gt; setState(() =&gt; ageText = v),
                        ),
                      ),
                      const SizedBox(width: 8),
                      Expanded(
                        child: TextFormField(
                          initialValue: role,
                          decoration: const InputDecoration(
                            labelText: 'R√¥le (admin/staff/membre)',
                            border: OutlineInputBorder(),
                          ),
                          onChanged: (v) =&gt; setState(() =&gt; role = v),
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 12),
                  TextFormField(
                    initialValue: note,
                    decoration: const InputDecoration(
                      labelText: 'Note (optionnel)',
                      border: OutlineInputBorder(),
                    ),
                    maxLines: 2,
                    onChanged: (v) =&gt; setState(() =&gt; note = v),
                  ),
                  const SizedBox(height: 16),
                  FilledButton.icon(
                    onPressed: _save,
                    icon: _saving
                      ? const SizedBox(width: 18, height: 18, child: CircularProgressIndicator(strokeWidth: 2))
                      : const Icon(Icons.save_outlined),
                    label: Text(isEdit ? 'Enregistrer' : 'Ajouter'),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}
</code></pre>

    <h3>üß† D√©cryptage ‚Äî <code>_save()</code> (ligne par ligne)</h3>
    <div class="tip">
      <p><code>if (!_formKey.currentState!.validate()) return;</code> ‚Äî stop si un champ requis est vide / √¢ge invalide.</p>
      <p><code>final col = FirebaseFirestore.instance.collection('membres');</code> ‚Äî on pointe vers la collection.</p>
      <p><code>final age = int.tryParse(ageText.trim()) ?? 0;</code> ‚Äî convertit l‚Äô√¢ge texte en nombre (0 si vide/invalide).</p>
      <p><code>if (widget.docId == null) ... else ...</code> ‚Äî <strong>cr√©ation</strong> si pas d‚ÄôID, sinon <strong>mise √† jour</strong>.</p>
      <p><code>serverTimestamp()</code> ‚Äî date √©crite c√¥t√© serveur (pr√©cise, coh√©rente pour tout le monde).</p>
      <p><code>note.trim().isEmpty ? null : note.trim()</code> ‚Äî on stocke <code>null</code> pour √©viter les cha√Ænes vides inutiles.</p>
      <p><code>Navigator.pop(context)</code> ‚Äî on revient √† la liste apr√®s succ√®s (qui se met √† jour toute seule).</p>
    </div>
  </section>

  <!-- 4) main.dart -->
  <section id="main" class="card">
    <h2><span class="badge">‚ñ∂</span>Point d‚Äôentr√©e ‚Äî <code>lib/main.dart</code></h2>
<pre><code>import 'package:flutter/material.dart';
import 'package:firebase_core/firebase_core.dart';
import 'firebase_options.dart';
import 'pages/member_list_page.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );
  runApp(const App());
}

class App extends StatelessWidget {
  const App({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'CRUD Membres (sans service)',
      theme: ThemeData(
        useMaterial3: true,
        colorScheme: ColorScheme.fromSeed(seedColor: const Color(0xFF8B5CF6)),
      ),
      home: const MemberListPage(),
    );
  }
}
</code></pre>
    <div class="tip">
      <p><code>WidgetsFlutterBinding.ensureInitialized()</code> ‚Äî requis avant <code>Firebase.initializeApp</code> asynchrone.</p>
      <p><code>firebase_options.dart</code> ‚Äî g√©n√©r√© par <span class="kbd">flutterfire configure</span>.</p>
    </div>
  </section>

  <!-- D√©pannage -->
  <section class="card">
    <h2>üõ†Ô∏è D√©pannage rapide</h2>
    <ul>
      <li><strong>‚Äúfirebase_options.dart introuvable‚Äù</strong> ‚Üí ex√©cute <span class="kbd">flutterfire configure</span> dans le projet.</li>
      <li><strong>‚ÄúPERMISSION_DENIED‚Äù</strong> ‚Üí r√®gles TEST bien d√©ploy√©es ? bon projet Firebase s√©lectionn√© ?</li>
      <li><strong>√Çge invalide</strong> ‚Üí retaper un nombre (ex. <code>22</code>) ; la validation refuse les lettres et les n√©gatifs.</li>
      <li><strong>Ordre incorrect</strong> ‚Üí recr√©er via le formulaire (on ajoute <code>createdAt</code> automatiquement).</li>
    </ul>
  </section>

  <!-- Mini-exos -->
  <section class="card">
    <h2>üéØ Mini-exercices</h2>
    <ul>
      <li>Ajouter un champ <code>email</code> (form + liste) avec validation ‚Äúcontient @‚Äù.</li>
      <li>Ajouter une confirmation avant suppression (d√©j√† montr√©, rends-la obligatoire).</li>
      <li>Ajouter un filtre d‚Äôaffichage (boutons ‚ÄúTous / Staff / Admin / Membre‚Äù).</li>
    </ul>
  </section>

  <footer class="card">
    <p>‚úî Le√ßon termin√©e. <strong>Prochaine le√ßon</strong> : introduire un <em>service</em> (centraliser Firestore) puis un <em>mod√®le</em> (<code>Member</code>) avec des types propres.</p>
  </footer>

</div>
</body>
</html>
